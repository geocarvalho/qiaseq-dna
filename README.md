# qiaseq-dna
This repository contains some example code for processing reads from QIAGEN QIAseq DNA enrichment kits.

python run examples
-------------------
The top level script run_qiaseq_dna.py process reads in fastq format to produce an annotated vcf along with relevant UMI and read level metrics. Variants are called using smCounter. The smCounter-v1 variant calling procedure is described here:

[Detecting very low allele fraction variants using targeted DNA sequencing and a novel molecular barcode-aware variant caller", BMC Genomics, 2017 18:5](https://bmcgenomics.biomedcentral.com/articles/10.1186/s12864-016-3425-4)

The smCounter variant caller uses a statistical model that requires both raw sequencer base calls and identification of unique input molecules using the UMI tag and the genome position of the random fragmentation site.

smCounter-v2 publication is under review. The pre-print is available here :

https://www.biorxiv.org/content/early/2018/03/14/281659

There are additional scripts under misc_workflow/ which contain the following :

1. **run_dedup** - Use the Picard MarkDuplicates utility from the Broad Institute to remove PCR duplicate reads using the UMI and both paired-end read start locations on the reference genome.  This might be useful for subsequent germline variant calling, or structural variant detection applications.  Note that this script does not filter ligation chimera reads, nor does it remove PCR duplicate reads caused by internal re-priming by a downstream SPE primer. 

2. **run_consensus** - Use the "fgbio" package from Fulcrum Genomics to create a single consensus read pair for each input molecule.  This might be useful to prepare consensus read alignments for a subsequent SNP/indel variant calling procedure that does not use UMI-tagged reads (such as VarDict, MuTect, etc.).  Users might need to tune the fgbio parameters (in addtion to variant calling parameters) for their application.  We have not performed any variant calling performance benchmarking using the consensus-read BAM generated by this pipeline.


python packages
---------------------
#### core  
This package contains modules that trim common regions of the reads, align reads to the reference genome, identify putative original input molecules, and trim SPE primer regions from the genome alignments.  These steps generate a BAM file suitable for subsequent variant calling.

#### metrics
This package contains auxiliary modules that provide read accounting and enrichment summary metrics such as uniformity and fragment length distribution.

#### qiaseq-smCounter-v1 @ *
This package contains the smCounter-v1 variant caller

#### qiaseq-smCounter-v2 @ *
This package contains the smCounter-v2 variant caller

#### annotate
This package contains downstream VCF annotation using snpEff.


Docker image for third-party dependencies
-----------------------------------------
The python modules in this repository have many dependencies on third-party NGS software (e.g. BWA, samtools, etc.) and GNU Linux utilities (sort, zcat, etc).  Please **DO NOT ATTEMPT** to use the python modules in this git repository without first running the code on the example read set using our Docker image:

```bash
### Pull the docker image
sudo docker pull rpadmanabhan9/qiaseq-dna:pipeline

### Run a container from the image above interactively, mounting your run directory i.e. directory where the output files will be created
sudo docker run -it -v /home/your_fav_dir/:/mnt/qiaseq-run/ rpadmanabhan9/qiaseq-dna:pipeline

### Change directory and get the latest code from github
cd /srv/qgen/code/
git clone --recursive https://github.com/qiaseq/qiaseq-dna.git

### Change to run directory and copy over parameters file
cd /mnt/qiaseq-run/
cp /srv/qgen/code/qiaseq-dna/run_sm_counter_v1.params.txt ./

### Edit the bottom of run_consensus.params.txt if you need to change the read set and primer file

### Run the pipeline
python /srv/qgen/code/qiaseq-dna/run_qiaseq_dna.py run_sm_counter_v1.params.txt v1 single NEB_S2 > run.log 2>&1 &  

The parameters are explained below :
run_sm_counter_v1.params.txt : The config file with prepopulated parameters.
v1 : smCounter variant caller version to use. You can specify v1 or v2. Please use run_sm_counter_v2.params.txt if specifying v2.
single : Whether this is a single read set analysis or tumor-normal.
NEB_S2 : Corresponds to the name of the readSet, should match the section in the params file. For tumor-normal analysis please specify the two read set names delimited by a space.

For ion torrent reads
### convert unmapped bam to fastq, this can be done inside the container
bedtools bamtofastq -i {ubam} -fq {fastq1}
uBam : your unmapped bam file
fastq1 : R1 fastq file name

Update the parameters in the config file :
uBam: Add a new parameter in the readSet section in the bottom with the path to the unmapped bam file
readFile1: Should be the R1 fastq obtained from the above bedtools command
readFile2: Replace 'R1' with 'R2' in readFile1 
platform: Change this to IonTorrent

Run the python script run_qiaseq_dna.py as before
```
The dependencies are fully documented in the Dockerfile in this repository.

Please address questions to raghavendra.padmanabhan@qiagen.com, with CC to john.dicarlo@qiagen.com.

---
# George annotations :panda_face:

## Requirements:

1. Clone the repository

```
% cd /path/to/dir
% git clone https://github.com/geocarvalho/qiaseq-dna.git
```

2. Inside the repository use `conda` to create a environment and activate it

```
% conda create -n qiaseq
% source activate  qiaseq
```

3. Install all the other stuffs:

```
% source activate qiaseq
% conda install -c bioconda bedtools=2.25.0 htslib=1.3.1 cutadapt=1.10 picard=1.97 snpeff=4.2 bwa=0.7.15
% wget https://storage.googleapis.com/qiaseq-dna/lib/ssw.tar.gz https://storage.googleapis.com/qiaseq-dna/lib/fgbio-0.1.4-SNAPSHOT.jar -P ./bin
% conda install -c bioconda scipy MySQL-python openpyxl pysam=0.9.0
% pip install statistics
% wget https://storage.googleapis.com/qiaseq-dna/lib/py-editdist-0.3.tar.gz https://storage.googleapis.com/qiaseq-dna/lib/sendgrid-v2.2.1.tar.gz -P ./downloads/
% cd ./downloads/ && \
    tar -xvf py-editdist-0.3.tar.gz && \
    cd py-editdist-0.3 && \
    python setup.py install && \
    cd .. && \
    tar -xvf sendgrid-v2.2.1.tar.gz && \
    cd sendgrid-python-2.2.1 && \
    python setup.py install
% echo "r <- getOption('repos'); r['CRAN'] <- 'http://cran.us.r-project.org'; options(repos = r);" > ~/.Rprofile
% Rscript -e "install.packages('plyr')"
% conda install -c cyclus java-jdk=8.45.14
% wget https://github.com/samtools/samtools/releases/download/1.5/samtools-1.5.tar.bz2 -O ./bin/downloads/samtools-1.5.tar.bz2
% cd ./bin/downloads/ && \
    tar -xvf samtools-1.5.tar.bz2 && \
    cd samtools-1.5  && \
    mkdir -p ../samtools-1.5 && \
    ./configure --prefix ../samtools-1.5 && \
    make && \
    make install
% wget https://storage.googleapis.com/qiaseq-dna/data/genome/ucsc.hg19.dict https://storage.googleapis.com/qiaseq-dna/data/genome/ucsc.hg19.fa.gz -P ./data/genome/
% cd ./data/genome && \
    gunzip ucsc.hg19.fa.gz  && \
    ## Index the fasta using samtools
    ./bin/samtools-1.5/bin/samtools faidx /srv/qgen/data/genome/ucsc.hg19.fa && \ 
    ## Run bwa to generate index files 
    bwa index /srv/qgen/data/genome/ucsc.hg19.fa
% wget https://storage.googleapis.com/qiaseq-dna/data/annotation/clinvar_20160531.vcf.gz \
         https://storage.googleapis.com/qiaseq-dna/data/annotation/clinvar_20160531.vcf.gz.tbi \
         https://storage.googleapis.com/qiaseq-dna/data/annotation/common_all_20160601.vcf.gz \
    	 https://storage.googleapis.com/qiaseq-dna/data/annotation/common_all_20160601.vcf.gz.tbi \
	 https://storage.googleapis.com/qiaseq-dna/data/annotation/CosmicAllMuts_v69_20140602.vcf.gz \
	 https://storage.googleapis.com/qiaseq-dna/data/annotation/CosmicAllMuts_v69_20140602.vcf.gz.tbi \
	 https://storage.googleapis.com/qiaseq-dna/data/annotation/simpleRepeat_TRF.bed \
	 https://storage.googleapis.com/qiaseq-dna/data/annotation/SR_LC_SL_RepeatMasker.bed \
	 https://storage.googleapis.com/qiaseq-dna/data/annotation/bkg.error.v2.RData \
	 https://storage.googleapis.com/qiaseq-dna/data/annotation/SR_LC_SL.full.bed \
	 https://storage.googleapis.com/qiaseq-dna/data/annotation/simpleRepeat.full.bed \
	  -P ./annotation/
% wget http://downloads.sourceforge.net/project/snpeff/databases/v4_2/snpEff_v4_2_GRCh37.75.zip -P /opt/conda/share/snpeff-4.2-0/
% cd /usr/local/anaconda/envs/qiaseq/share/snpeff-4.2-0/ && \
    unzip snpEff_v4_2_GRCh37.75.zip
% cpan DateTime \
	cpan DBI \
	cpan DBD::SQLite \
	cpan Env::Path \
	cpan File::chdir \
	cpan Getopt::Long::Descriptive \
	cpan Sort:Naturally \
	cpan Config::IniFiles \
	cpan Data::Dump::Color \
	cpan Data::Table::Excel \
	cpan Hash::Merge \
	cpan File::Slurp
% Rscript -e "install.packages('MASS')" 
% Rscript -e "install.packages('ggplot2')" 
% Rscript -e "install.packages('gridExtra')" 
% Rscript -e "install.packages('naturalsort')" 
% Rscript -e "install.packages('scales')" 
% Rscript -e "install.packages('ggplot2')" 
% Rscript -e "install.packages('extrafont')"
% mkdir TorrentSuite && cd TorrentSuite
% wget https://storage.googleapis.com/qiaseq-dna/lib/TorrentSuite/tmap      https://storage.googleapis.com/qiaseq-dna/lib/TorrentSuite/tvc
% chmod 775 tmap tvc
% mkdir example && cd example
% wget https://storage.googleapis.com/qiaseq-dna/example/NEB_S2_L001_R1_001.fastq.gz      https://storage.googleapis.com/qiaseq-dna/example/NEB_S2_L001_R2_001.fastq.gz  https://storage.googleapis.com/qiaseq-dna/example/DHS-101Z.primers.txt   https://storage.googleapis.com/qiaseq-dna/example/DHS-101Z.roi.bed
% mkdir test_smcounter-v2 && cd test_smcounter-v2
% wget https://storage.googleapis.com/qiaseq-dna/test_files/high.confidence.variants.bed          https://storage.googleapis.com/qiaseq-dna/test_files/NB956-240-3-10_S1.highconfidence.bam  https://storage.googleapis.com/qiaseq-dna/test_files/NB956-240-3-10_S1.highconfidence.VariantList.long.txt  https://storage.googleapis.com/qiaseq-dna/test_files/NB956-240-3-10_S1.highconfidence.bam.bai
% conda install -c bioconda vcflib
% git clone https://github.com/reineckef/quandico.git && cd quandico
	bash install.sh
```

## To run it using the George Carvalho changes:

```
% python run_qiaseq_dna_gnmk.py run_sm_counter_v1.params.txt v1 single /path/to/Sample_L001_R1_001.fastq.gz /path/to/Sample_L001_R2_001.fastq.gz /path/to/output/dir/ /path/to/Panel.primer3.txt /path/to/Panel.roi.bed
```
